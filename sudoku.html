<!DOCTYPE html>
<html lang="en" style="height: 100%;">
   
    <style>
        body{
            text-align: center;
        }
        img{
            width: auto;
        }
    </style>
<body>
   
<canvas id="myCanvas" width="400" height="400" style="border:1px solid grey"></canvas>


<script>
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");
    canvas.height = canvas.width;

    size = 2
    step = canvas.width/(size**2)
    h = canvas.height
    w = canvas.width

    digits = []
    Variables = {}
    Constraints = {}
    all_contraints = []
    //make digits and constraints
    for(let i =0; i<size**2; i++){
        digits.push(i+1)
        for(let j =0; j<size**2; j++){
            if(i==j){continue}
            all_contraints.push([i+1,j+1])
        }
    }

    function LargerPals(x_in,y_in){
        pals = []
        for(let x = x_in+1; x < size**2; x++){
            pals.push([x+1,y_in+1])
        }
        for(let y = y_in+1; y < size**2; y++){
            pals.push([x_in+1,y+1])
        }
        xstart = Math.floor(x_in/size)*size
        ystart = Math.floor(y_in/size)*size
        for(let x = 0; x < size; x++){
            for(let y = 0; y < size; y++){
                if(xstart+x>x_in || xstart+x==x_in && ystart+y>y_in){
                    pals.push([xstart+x+1,ystart+y+1])
                }
                
            }
        }
        return pals
    }
    function AllPals(x_in,y_in){
        pals = []
        for(let x = 0; x < size**2; x++){
            pals.push([x+1,y_in+1])
        }
        for(let y = 0; y < size**2; y++){
            pals.push([x_in+1,y+1])
        }
        xstart = Math.floor(x_in/size)*size
        ystart = Math.floor(y_in/size)*size
        for(let x = 0; x < size; x++){
            for(let y = 0; y < size; y++){
                    pals.push([xstart+x+1,ystart+y+1])
            }
        }
        return pals
    }

    for (let i = 0; i < size**2; i++) {
        for (let j = 0; j < size**2; j++) {
            var_name = '['+JSON.stringify(i+1)+','+JSON.stringify(j+1)+']'
            Variables[var_name] = digits
            pals = LargerPals(i,j)

            pals.forEach(pal =>{
                v2 = '['+JSON.stringify(pal[0])+','+JSON.stringify(pal[1])+']'
                Constraints[var_name+'-'+v2] = all_contraints
            })

        }
    }

 
    function UpdateBoard(Variables){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < size**2; i++) {
            for (let j = 0; j < size**2; j++) {
                var_name = '['+JSON.stringify(i+1)+','+JSON.stringify(j+1)+']'
                domain = Variables[var_name]


                x = i*step
                y = j*step
                if(j%size==0 && i%size==0){
                    ctx.lineWidth = 5;
                }else{
                    ctx.lineWidth = 1;
                }
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, h);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
                if(domain.length == 1){
                    text =JSON.stringify(domain[0])
                    //later we can make the font size vary with the canvas size
                    ctx.font = "50px Arial";
                    ctx.fillText(text, x+(.35*step), y+(.65*step));
                }else{
                    text = JSON.stringify(domain)
                    //later we can make the font size vary with the canvas size
                    ctx.font = "10px Arial";
                    ctx.fillText(text, x+(.3*step), y+(.5*step));
                }

            }
        }
    }
   
    UpdateBoard(Variables)
    function revise(Constraints,Variables,var1,var2){
        if (var1==var2){return false}
        return_value = false
        try{
            ordered = true
            constraint_list = JSON.parse(JSON.stringify(Constraints[var1+'-'+var2]))
            //next line is there to make in err so we can go to the catch
            constraint_list.length
        }catch{
            ordered = false
            const temp = var1
            var1 = var2
            var2 = temp
            constraint_list = JSON.parse(JSON.stringify(Constraints[var1+'-'+var2]))
        }
        //now when we say var1 we always mean the first one
        Vars = [var1,var2]
        k = Math.round(ordered)
        //get rid of constraints that are't valid cause var2 dont have the va in its domain
        for(let i = 0; i < constraint_list.length; i++){
            if(Variables[Vars[k]].indexOf(constraint_list[i][k]) == -1){
                //we don't delete it now cause then the numbering gets weird in the for loop
                constraint_list[i] = 'DELETE'
            }
        }
        constraint_list = constraint_list.filter((el) => el != "DELETE")
        Constraints[var1+'-'+var2] = constraint_list


        //delete number from var1 domain if tht number does not have an asscioated constraint
        k = Math.round(!ordered)
        domain = JSON.parse(JSON.stringify(Variables[Vars[k]]))
        for(let i = 0; i < domain.length; i++){
            delete_this_option = true
            for(let j = 0; j < constraint_list.length; j++){
                if(domain[i] == constraint_list[j][k]){
                    delete_this_option = false
                }
            }
            if(delete_this_option){
                return_value = true
                domain[i] = 'DELETE'
            }
        }
        domain = domain.filter((el) => el != "DELETE")
        Variables[Vars[k]] = domain
        

        return return_value
    }
    function AddToList(v1,v2,checklist){
        
                var1 = v1.slice(1,v1.length-1)
                var1 = var1.split(',')
                i = JSON.parse(var1[0])-1
                j = JSON.parse(var1[1])-1
                pals = AllPals(i,j)
                for(let i = 0; i < pals.length; i++){
                    var_name = '['+JSON.stringify(pals[i][0])+','+JSON.stringify(pals[i][1])+']'
                    checklist.push([v1,var_name])
                }
                //now properly add pals to checklist, and make sure things arent pals with themselves
        
        return checklist
    }
    function AC3(CSP,Variables){
        pairs = Object.keys(CSP)
        checklist = []
        pairs.forEach(pair =>{
            pair = pair.split('-')
            checklist.push(pair)
        })

        while(checklist.length > 0){
            [v1,v2] = checklist[0];
            if(revise(CSP,Variables,v1,v2)){checklist = AddToList(v1,v2,checklist);}
            [v2,v1] = checklist[0];
            if(revise(CSP,Variables,v1,v2)){checklist = AddToList(v1,v2,checklist);}
            checklist.shift();
        }

    }
    function minimum_remaining_values(CSP,Variables){
        Var_names = Object.keys(Variables)
        all_lengths = {}
        for (let i = 0; i < Var_names.length; i++) {
            this_length = Variables[Var_names[i]].length
            if( this_length != 1){
                all_lengths[this_length] = Var_names[i]
            }
        }
        min_l = Math.min(...Object.keys(all_lengths))
        min_V = all_lengths[min_l]
        return min_V
    }

    //Variables['[1,1]'] = [1]
    Variables['[2,2]'] = [2]
    //Variables['[3,3]'] = [3]
    //Variables['[4,4]'] = [4]
    revise(Constraints,Variables,'[1,1]','[2,2]')
    AC3(Constraints,Variables)
    UpdateBoard(Variables)
    a =minimum_remaining_values(Constraints,Variables)
    console.log(a)
    console.log(Variables)
</script>
</body>
</html>
